{"version":3,"file":"PageResourceLoader_test.js","sourceRoot":"","sources":["../../../../../../../../test/unittests/front_end/core/sdk/PageResourceLoader_test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nconst {assert} = chai;\n\nimport type * as Host from '../../../../../front_end/core/host/host.js';\nimport * as SDK from '../../../../../front_end/core/sdk/sdk.js';\nimport * as Platform from '../../../../../front_end/core/platform/platform.js';\nimport type * as Protocol from '../../../../../front_end/generated/protocol.js';\nimport {describeWithLocale} from '../../helpers/EnvironmentHelpers.js';\n\ninterface LoadResult {\n  success: boolean;\n  content: string;\n  errorDescription: Host.ResourceLoader.LoadErrorDescription;\n}\n\ndescribeWithLocale('PageResourceLoader', () => {\n  const foo1Url = 'foo1' as Platform.DevToolsPath.UrlString;\n  const foo2Url = 'foo2' as Platform.DevToolsPath.UrlString;\n  const foo3Url = 'foo3' as Platform.DevToolsPath.UrlString;\n  const loads: Array<{url: string}> = [];\n  const load = async(url: string): Promise<LoadResult> => {\n    loads.push({url});\n\n    return {\n      success: true,\n      content: `${url} - content`,\n      errorDescription: {message: '', statusCode: 0, netError: 0, netErrorName: '', urlValid: true},\n    };\n  };\n\n  const initiator = {\n    target: null,\n    frameId: '123' as Protocol.Page.FrameId,\n    initiatorUrl: Platform.DevToolsPath.EmptyUrlString,\n  };\n\n  beforeEach(() => {\n    loads.length = 0;\n  });\n\n  it('loads resources correctly', async () => {\n    const loader = SDK.PageResourceLoader.PageResourceLoader.instance(\n        {forceNew: true, loadOverride: load, maxConcurrentLoads: 500, loadTimeout: 30000});\n    const loading = [\n      loader.loadResource(foo1Url, initiator),\n      loader.loadResource(foo2Url, initiator),\n      loader.loadResource(foo3Url, initiator),\n    ];\n\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 3, queued: 0, resources: 3});\n\n    const results = await Promise.all(loading);\n    assert.deepEqual(loads.map(x => x.url), ['foo1', 'foo2', 'foo3']);\n    assert.deepEqual(results.map(x => x.content), ['foo1 - content', 'foo2 - content', 'foo3 - content']);\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 0, queued: 0, resources: 3});\n    const resources = Array.from(loader.getResourcesLoaded().values());\n    assert.isTrue(resources.every(x => x.success));\n  });\n\n  it('deals with page reloads correctly', async () => {\n    const loader = SDK.PageResourceLoader.PageResourceLoader.instance(\n        {forceNew: true, loadOverride: load, maxConcurrentLoads: 1, loadTimeout: 30000});\n    const loading = [\n      loader.loadResource(foo1Url, initiator).catch(e => e.message),\n      loader.loadResource(foo2Url, initiator).catch(e => e.message),\n      loader.loadResource(foo3Url, initiator).catch(e => e.message),\n    ];\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 3, queued: 2, resources: 3});\n\n    loader.onMainFrameNavigated({\n      data: {\n        isTopFrame() {\n          return true;\n        },\n      } as SDK.ResourceTreeModel.ResourceTreeFrame,\n    });\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 3, queued: 0, resources: 0});\n\n    const results = await Promise.all(loading);\n    assert.deepEqual(loads.map(x => x.url), ['foo1']);\n    assert.deepEqual(results[0].content, 'foo1 - content');\n    assert.deepEqual(results[1], 'Load canceled due to reload of inspected page');\n    assert.deepEqual(results[2], 'Load canceled due to reload of inspected page');\n  });\n\n  it('handles the load timeout correctly', async () => {\n    const load = (url: string): Promise<LoadResult> => {\n      loads.push({url});\n      return new Promise(() => {});\n    };\n\n    const loader = SDK.PageResourceLoader.PageResourceLoader.instance(\n        {forceNew: true, loadOverride: load, maxConcurrentLoads: 2, loadTimeout: 30});\n    const loading = [\n      loader.loadResource(foo1Url, initiator).catch(e => e.message),\n      loader.loadResource(foo2Url, initiator).catch(e => e.message),\n      loader.loadResource(foo3Url, initiator).catch(e => e.message),\n    ];\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 3, queued: 1, resources: 3});\n\n    const results = await Promise.all(loading);\n    assert.deepEqual(loads.map(x => x.url), ['foo1', 'foo2', 'foo3']);\n    const resources = Array.from(loader.getResourcesLoaded().values());\n    assert.isTrue(resources.every(x => !x.success), 'All resources should have failed to load');\n    assert.isTrue(\n        results.every(x => x === 'Load canceled due to load timeout'),\n        'All loads should have a exceeded the load timeout');\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 0, queued: 0, resources: 3});\n  });\n\n  it('respects the max concurrent loads', async () => {\n    const loader = SDK.PageResourceLoader.PageResourceLoader.instance(\n        {forceNew: true, loadOverride: load, maxConcurrentLoads: 2, loadTimeout: 30});\n    const loading = [\n      loader.loadResource(foo1Url, initiator),\n      loader.loadResource(foo2Url, initiator),\n      loader.loadResource(foo3Url, initiator),\n    ];\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 3, queued: 1, resources: 3});\n\n    const results = await Promise.all(loading);\n    assert.deepEqual(loads.map(x => x.url), ['foo1', 'foo2', 'foo3']);\n    assert.deepEqual(results.map(x => x.content), ['foo1 - content', 'foo2 - content', 'foo3 - content']);\n    assert.deepEqual(loader.getNumberOfResources(), {loading: 0, queued: 0, resources: 3});\n    const resources = Array.from(loader.getResourcesLoaded().values());\n    assert.isTrue(resources.every(x => x.success));\n  });\n});\n"]}