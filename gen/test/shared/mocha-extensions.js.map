{"version":3,"file":"mocha-extensions.js","sourceRoot":"","sources":["../../../../../test/shared/mocha-extensions.ts"],"names":[],"mappings":";AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;;;AAE7B,+BAA+B;AAC/B,6BAA6B;AAE7B,wEAAmE;AAEnE,qDAA4C;AAC5C,2CAAsC;AAEtC,2CAAqC;AAErC,+BAAiC;AAAzB,mGAAA,UAAU,OAAA;AAEX,KAAK,UAAU,eAAe;IACnC,IAAI;QACF,MAAM,EAAC,MAAM,EAAE,QAAQ,EAAC,GAAG,IAAA,uCAAkB,GAAE,CAAC;QAChD,MAAM,IAAI,GAAG;YACX,QAAQ,EAAE,QAAoB;SAC/B,CAAC;QACF,MAAM,gBAAgB,GAAG,MAAM,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QACvD,MAAM,kBAAkB,GAAG,MAAM,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QAC3D,MAAM,MAAM,GAAG,wBAAwB,CAAC;QACxC,OAAO,CAAC,KAAK,CAAC,sEAAsE,CAAC,CAAC;QACtF,OAAO,CAAC,KAAK,CAAC,MAAM,GAAG,gBAAgB,CAAC,CAAC;QACzC,OAAO,CAAC,KAAK,CAAC,mEAAmE,CAAC,CAAC;QACnF,OAAO,CAAC,KAAK,CAAC,MAAM,GAAG,kBAAkB,CAAC,CAAC;KAC5C;IAAC,OAAO,GAAG,EAAE;QACZ,OAAO,CAAC,KAAK,CAAC,2BAA2B,EAAE,GAAG,CAAC,CAAC;KACjD;AACH,CAAC;AAhBD,0CAgBC;AAED,SAAgB,YAAY,CACxB,OAAoE,EAAE,KAAa,EACnF,EAA+B;IACjC,MAAM,UAAU,GAAG,KAAK,CAAC,iBAAiB,CAAC;IAC3C,IAAI;QACF,KAAK,CAAC,iBAAiB,GAAG,CAAC,GAAG,EAAE,WAAW,EAAE,EAAE;YAC7C,IAAI,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE;gBAC1B,OAAO,WAAW,CAAC;aACpB;YACD,MAAM,QAAQ,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC;YAC9C,IAAI,CAAC,QAAQ,EAAE;gBACb,OAAO,WAAW,CAAC;aACpB;YACD,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;YACxC,MAAM,WAAW,GAAG,UAAU,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACnD,MAAM,KAAK,GAAG,WAAW,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAC7C,IAAI,KAAK,GAAG,CAAC,EAAE;gBACb,OAAO,UAAU,CAAC,IAAI,CAAC;aACxB;YACD,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,WAAW,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,EAAE,GAAG,UAAU,CAAC,IAAI,KAAK,CAAC,CAAC;QAC7E,CAAC,CAAC;QACF,MAAM,GAAG,GAAG,IAAI,KAAK,EAAE,CAAC;QAExB,OAAO,OAAO,CAAC,GAAG,GAAG,CAAC,KAAK,KAAK,KAAK,EAAE,EAAE,EAAE,CAAC,CAAC;KAC9C;YAAS;QACR,KAAK,CAAC,iBAAiB,GAAG,UAAU,CAAC;KACtC;AACH,CAAC;AA3BD,oCA2BC;AAED,SAAgB,QAAQ,CAAC,KAAa,EAAE,EAA+B;IACrE,OAAO,YAAY,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;AACjD,CAAC;AAFD,4BAEC;AAED,QAAQ,CAAC,IAAI,GAAG,UAAS,KAAa,EAAE,EAA+B;IACrE,OAAO,YAAY,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;AACtD,CAAC,CAAC;AAEF,QAAQ,CAAC,IAAI,GAAG,UAAS,KAAa,EAAE,EAA+B;IACrE,OAAO,YAAY,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;AACtD,CAAC,CAAC;AAEF,QAAQ,CAAC,eAAe,GAAG,UAAS,SAA0B,EAAE,IAAY,EAAE,EAA+B;IAC3G,MAAM,UAAU,GAAG,SAAS,CAAC,QAAQ,CAAC,oBAAQ,CAAC,CAAC;IAChD,IAAI,UAAU,EAAE;QACd,YAAY,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;KAC7C;SAAM;QACL,QAAQ,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;KACpB;AACH,CAAC,CAAC;AAEF,8DAA8D;AAC9D,KAAK,UAAU,WAAW,CAAuB,IAA0B,EAAE,GAAS;IACpF,QAAQ,CAAC,CAAC,UAAU;QAClB,MAAM,MAAM,GAAG,2BAAU,CAAC,MAAM,CAAC;QACjC,IAAI,MAAM,CAAC,IAAI,KAAK,CAAC,EAAE;YACrB,OAAO;SACR;QACD,KAAK,MAAM,KAAK,IAAI,MAAM,CAAC,MAAM,EAAE,EAAE;YACnC,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC;YAC1B,KAAK,CAAC,WAAW,EAAE,CAAC;YACpB,IAAI,KAAK,EAAE;gBACT,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC;aAC/B;SACF;IACH,CAAC;IAED,MAAM,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC;IACxC,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;QACrB,OAAO,CAAC,KAAK,CAAC,6CAA6C,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;KACnF;IACD,IAAI,GAAG,IAAI,CAAC,IAAA,qBAAS,EAAC,YAAY,CAAC,EAAE;QACnC,MAAM,eAAe,EAAE,CAAC;KACzB;IACD,IAAI,IAAI,EAAE;QACR,8DAA8D;QAC9D,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;QACtB,IAAI,CAAC,GAAG,CAAC,CAAC;QACV,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;KACtB;AACH,CAAC;AAEY,QAAA,EAAE,GAAG,mBAAmB,EAAE,CAAC;AAIxC,MAAM,UAAU,GAAG,IAAA,qBAAS,EAAC,YAAY,EAAE,CAAC,CAAC,CAAC;AAE9C,SAAS,eAAe,CAAC,SAAiB;IACxC,IAAI,SAAS,KAAK,CAAC,EAAE;QACnB,OAAO,EAAE,CAAC;KACX;IACD,OAAO,MAAM,SAAS,GAAG,CAAC;AAC5B,CAAC;AAED,SAAgB,mBAAmB,CAAC,aAAqB,EAAE;IACzD,MAAM,cAAc,GAAG,UAAS,IAAY,EAAE,QAAuB;QACnE,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,EAAE,CAAC,EAAE,EAAE;YACnC,MAAM,QAAQ,GAAG,UAAU,CAAC,CAAC,CAAC,GAAG,UAAU,IAAI,IAAI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;YAC7D,aAAa,CAAC,KAAK,CAAC,EAAE,EAAE,QAAQ,GAAG,eAAe,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC;SAClE;IACH,CAAC,CAAC;IAEF,cAAc,CAAC,IAAI,GAAG,UAAS,IAAY,EAAE,QAAoC;QAC/E,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,CAAC,CAAC;IAC/C,CAAC,CAAC;IAEF,cAAc,CAAC,eAAe,GAAG,UAC7B,SAA0B,EAAE,IAAY,EAAE,QAAoC;QAChF,MAAM,UAAU,GAAG,SAAS,CAAC,QAAQ,CAAC,oBAAQ,CAAC,CAAC;QAChD,IAAI,UAAU,EAAE;YACd,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,CAAC,CAAC;SAC9C;aAAM;YACL,IAAA,UAAE,EAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;SACpB;IACH,CAAC,CAAC;IAEF,cAAc,CAAC,IAAI,GAAG,UAAS,IAAY,EAAE,QAAoC;QAC/E,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,EAAE,CAAC,EAAE,EAAE;YACnC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE,IAAI,GAAG,eAAe,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC;SACnE;IACH,CAAC,CAAC;IAEF,cAAc,CAAC,MAAM,GAAG,UAAS,MAAc,EAAE,IAAY,EAAE,QAAoC;QACjG,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,EAAE;YAC/B,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,CAAC,CAAC;SAC9C;IACH,CAAC,CAAC;IAEF,OAAO,cAAc,CAAC;AACxB,CAAC;AAnCD,kDAmCC;AAED,SAAS,aAAa,CAClB,IAA8E,EAAE,IAAY,EAC5F,QAAoC;IACtC,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,EAAE,UAAS,IAAgB;QAC/C,IAAI,IAAI,EAAE;YACR,MAAM,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC;YACnC,IAAI,CAAC,QAAQ,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;YACrD,sEAAsE;YACtE,IAAI,CAAC,YAAY,EAAE,CAAC;SACrB;QAED,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE;YACxB,QAA4B,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;SAC7D;aAAM;YACJ,QAAuB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC;SAC3C;IACH,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Mocha from 'mocha';\nimport * as Path from 'path';\n\nimport {getBrowserAndPages} from '../conductor/puppeteer-state.js';\n\nimport {AsyncScope} from './async-scope.js';\nimport {getEnvVar} from './config.js';\nimport type {Platform} from './helper.js';\nimport {platform} from './helper.js';\n\nexport {beforeEach} from 'mocha';\n\nexport async function takeScreenshots() {\n  try {\n    const {target, frontend} = getBrowserAndPages();\n    const opts = {\n      encoding: 'base64' as 'base64',\n    };\n    const targetScreenshot = await target.screenshot(opts);\n    const frontendScreenshot = await frontend.screenshot(opts);\n    const prefix = 'data:image/png;base64,';\n    console.error('Target page screenshot (copy the next line and open in the browser):');\n    console.error(prefix + targetScreenshot);\n    console.error('Frontend screenshot (copy the next line and open in the browser):');\n    console.error(prefix + frontendScreenshot);\n  } catch (err) {\n    console.error('Error taking a screenshot', err);\n  }\n}\n\nexport function wrapDescribe<ReturnT>(\n    mochaFn: (title: string, fn: (this: Mocha.Suite) => void) => ReturnT, title: string,\n    fn: (this: Mocha.Suite) => void): ReturnT {\n  const originalFn = Error.prepareStackTrace;\n  try {\n    Error.prepareStackTrace = (err, stackTraces) => {\n      if (stackTraces.length < 3) {\n        return '<unknown>';\n      }\n      const filename = stackTraces[2].getFileName();\n      if (!filename) {\n        return '<unknown>';\n      }\n      const parsedPath = Path.parse(filename);\n      const directories = parsedPath.dir.split(Path.sep);\n      const index = directories.lastIndexOf('e2e');\n      if (index < 0) {\n        return parsedPath.name;\n      }\n      return Path.join(...directories.slice(index + 1), `${parsedPath.name}.ts`);\n    };\n    const err = new Error();\n\n    return mochaFn(`${err.stack}: ${title}`, fn);\n  } finally {\n    Error.prepareStackTrace = originalFn;\n  }\n}\n\nexport function describe(title: string, fn: (this: Mocha.Suite) => void) {\n  return wrapDescribe(Mocha.describe, title, fn);\n}\n\ndescribe.only = function(title: string, fn: (this: Mocha.Suite) => void) {\n  return wrapDescribe(Mocha.describe.only, title, fn);\n};\n\ndescribe.skip = function(title: string, fn: (this: Mocha.Suite) => void) {\n  return wrapDescribe(Mocha.describe.skip, title, fn);\n};\n\ndescribe.skipOnPlatforms = function(platforms: Array<Platform>, name: string, fn: (this: Mocha.Suite) => void) {\n  const shouldSkip = platforms.includes(platform);\n  if (shouldSkip) {\n    wrapDescribe(Mocha.describe.skip, name, fn);\n  } else {\n    describe(name, fn);\n  }\n};\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function timeoutHook(this: Mocha.Runnable, done: Mocha.Done|undefined, err?: any) {\n  function* joinStacks() {\n    const scopes = AsyncScope.scopes;\n    if (scopes.size === 0) {\n      return;\n    }\n    for (const scope of scopes.values()) {\n      const stack = scope.stack;\n      scope.setCanceled();\n      if (stack) {\n        yield `${stack.join('\\n')}\\n`;\n      }\n    }\n  }\n\n  const stacks = Array.from(joinStacks());\n  if (stacks.length > 0) {\n    console.error(`Pending async operations during failure:\\n${stacks.join('\\n\\n')}`);\n  }\n  if (err && !getEnvVar('DEBUG_TEST')) {\n    await takeScreenshots();\n  }\n  if (done) {\n    // This workaround is needed to allow timeoutHook to be async.\n    this.timedOut = false;\n    done(err);\n    this.timedOut = true;\n  }\n}\n\nexport const it = makeCustomWrappedIt();\n\ntype MochaCallback = Mocha.Func|Mocha.AsyncFunc;\n\nconst iterations = getEnvVar('ITERATIONS', 1);\n\nfunction iterationSuffix(iteration: number): string {\n  if (iteration === 0) {\n    return '';\n  }\n  return ` (#${iteration})`;\n}\n\nexport function makeCustomWrappedIt(namePrefix: string = '') {\n  const newMochaItFunc = function(name: string, callback: MochaCallback) {\n    for (let i = 0; i < iterations; i++) {\n      const testName = namePrefix ? `${namePrefix} ${name}` : name;\n      wrapMochaCall(Mocha.it, testName + iterationSuffix(i), callback);\n    }\n  };\n\n  newMochaItFunc.skip = function(name: string, callback: Mocha.Func|Mocha.AsyncFunc) {\n    wrapMochaCall(Mocha.it.skip, name, callback);\n  };\n\n  newMochaItFunc.skipOnPlatforms = function(\n      platforms: Array<Platform>, name: string, callback: Mocha.Func|Mocha.AsyncFunc) {\n    const shouldSkip = platforms.includes(platform);\n    if (shouldSkip) {\n      wrapMochaCall(Mocha.it.skip, name, callback);\n    } else {\n      it(name, callback);\n    }\n  };\n\n  newMochaItFunc.only = function(name: string, callback: Mocha.Func|Mocha.AsyncFunc) {\n    for (let i = 0; i < iterations; i++) {\n      wrapMochaCall(Mocha.it.only, name + iterationSuffix(i), callback);\n    }\n  };\n\n  newMochaItFunc.repeat = function(repeat: number, name: string, callback: Mocha.Func|Mocha.AsyncFunc) {\n    for (let i = 0; i < repeat; i++) {\n      wrapMochaCall(Mocha.it.only, name, callback);\n    }\n  };\n\n  return newMochaItFunc;\n}\n\nfunction wrapMochaCall(\n    call: Mocha.TestFunction|Mocha.PendingTestFunction|Mocha.ExclusiveTestFunction, name: string,\n    callback: Mocha.Func|Mocha.AsyncFunc) {\n  const test = call(name, function(done: Mocha.Done) {\n    if (test) {\n      const originalDone = test.callback;\n      test.callback = timeoutHook.bind(test, originalDone);\n      // If a timeout is already scheduled, reset it to install our new hook\n      test.resetTimeout();\n    }\n\n    if (callback.length === 0) {\n      (callback as Mocha.AsyncFunc).bind(this)().then(done, done);\n    } else {\n      (callback as Mocha.Func).bind(this)(done);\n    }\n  });\n}\n"]}