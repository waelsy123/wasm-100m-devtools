{"version":3,"file":"storage_test.js","sourceRoot":"","sources":["../../../../../../test/e2e/application/storage_test.ts"],"names":[],"mappings":";AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;;AAE7B,+BAA4B;AAE5B,sDAAqG;AACrG,0EAA8D;AAC9D,8EAAqK;AAErK,wGAAwG;AACxG,MAAM,gBAAgB,GAAG,+BAA+B,CAAC;AACzD,MAAM,gBAAgB,GAAG,wBAAwB,CAAC;AAClD,MAAM,+BAA+B,GAAG,4BAA4B,CAAC;AACrE,MAAM,kCAAkC,GAAG,8CAA8C,CAAC;AAE1F,IAAI,eAAuB,CAAC;AAE5B,IAAA,8BAAQ,EAAC,qBAAqB,EAAE,KAAK,IAAI,EAAE;IACzC,MAAM,CAAC,KAAK,IAAI,EAAE;QAChB,eAAe,GAAG,GAAG,gBAAgB,0CAA0C,IAAA,6BAAiB,GAAE,IAAI,CAAC;IACzG,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,KAAK,IAAI,EAAE;QACnB,MAAM,EAAC,MAAM,EAAC,GAAG,IAAA,8BAAkB,GAAE,CAAC;QACtC,MAAM,OAAO,GAAG,MAAM,MAAM,CAAC,OAAO,EAAE,CAAC;QACvC,MAAM,MAAM,CAAC,YAAY,CAAC,GAAG,OAAO,CAAC,CAAC;IACxC,CAAC,CAAC,CAAC;IAEH,IAAA,wBAAE,EAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE;QACxE,MAAM,EAAC,MAAM,EAAC,GAAG,IAAA,8BAAkB,GAAE,CAAC;QACtC,MAAM,IAAA,iDAAwB,EAAC,MAAM,EAAE,sBAAsB,CAAC,CAAC;QAE/D,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QAClD,MAAM,IAAA,kDAAyB,EAAC,eAAe,CAAC,CAAC;QAEjD,MAAM,uBAAuB,GAAG,MAAM,IAAA,2BAAe,EAAC,KAAK,IAAI,EAAE;YAC/D,MAAM,IAAI,GAAG,MAAM,IAAA,4CAAmB,EAAC,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC;QACxC,CAAC,CAAC,CAAC;QAEH,aAAM,CAAC,eAAe,CAAC,uBAAuB,EAAE;YAC9C;gBACE,IAAI,EAAE,aAAa;gBACnB,KAAK,EAAE,MAAM;aACd;YACD;gBACE,IAAI,EAAE,MAAM;gBACZ,KAAK,EAAE,KAAK;aACb;YACD;gBACE,IAAI,EAAE,KAAK;gBACX,KAAK,EAAE,KAAK;aACb;SACF,CAAC,CAAC;QAEH,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QAClD,MAAM,IAAA,iBAAK,EAAC,+BAA+B,CAAC,CAAC;QAE7C,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QAClD,MAAM,IAAA,kDAAyB,EAAC,eAAe,CAAC,CAAC;QAEjD,MAAM,sBAAsB,GAAG,MAAM,IAAA,2BAAe,EAAC,KAAK,IAAI,EAAE;YAC9D,MAAM,IAAI,GAAG,MAAM,IAAA,4CAAmB,EAAC,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC;QACxC,CAAC,CAAC,CAAC;QACH,aAAM,CAAC,eAAe,CAAC,sBAAsB,EAAE,CAAC;gBACvB,IAAI,EAAE,aAAa;gBACnB,KAAK,EAAE,MAAM;aACd,CAAC,CAAC,CAAC;IAC7B,CAAC,CAAC,CAAC;IAEH,IAAA,wBAAE,EAAC,qFAAqF,EAAE,KAAK,IAAI,EAAE;QACnG,MAAM,EAAC,MAAM,EAAC,GAAG,IAAA,8BAAkB,GAAE,CAAC;QACtC,iCAAiC;QACjC,MAAM,IAAA,iDAAwB,EAAC,MAAM,EAAE,sBAAsB,CAAC,CAAC;QAE/D,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QAClD,MAAM,IAAA,kDAAyB,EAAC,eAAe,CAAC,CAAC;QAEjD,MAAM,uBAAuB,GAAG,MAAM,IAAA,2BAAe,EAAC,KAAK,IAAI,EAAE;YAC/D,MAAM,IAAI,GAAG,MAAM,IAAA,4CAAmB,EAAC,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC;QACxC,CAAC,CAAC,CAAC;QAEH,aAAM,CAAC,eAAe,CAAC,uBAAuB,EAAE;YAC9C;gBACE,IAAI,EAAE,aAAa;gBACnB,KAAK,EAAE,MAAM;aACd;YACD;gBACE,IAAI,EAAE,MAAM;gBACZ,KAAK,EAAE,KAAK;aACb;YACD;gBACE,IAAI,EAAE,KAAK;gBACX,KAAK,EAAE,KAAK;aACb;SACF,CAAC,CAAC;QAEH,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QAClD,MAAM,IAAA,iBAAK,EAAC,kCAAkC,CAAC,CAAC;QAChD,MAAM,IAAA,iBAAK,EAAC,+BAA+B,CAAC,CAAC;QAE7C,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QAClD,MAAM,IAAA,kDAAyB,EAAC,eAAe,CAAC,CAAC;QAEjD,MAAM,IAAA,2BAAe,EAAC,KAAK,IAAI,EAAE;YAC/B,MAAM,IAAI,GAAG,MAAM,IAAA,4CAAmB,EAAC,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC,MAAM,KAAK,CAAC,CAAC;QAC3B,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,IAAA,8BAAQ,EAAC,kBAAkB,EAAE,KAAK;QAChC,kFAAkF;QAClF,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACpB,UAAU,CAAC,KAAK,IAAI,EAAE;YACpB,MAAM,EAAC,MAAM,EAAC,GAAG,IAAA,8BAAkB,GAAE,CAAC;YACtC,MAAM,IAAA,iDAAwB,EAAC,MAAM,EAAE,eAAe,CAAC,CAAC;YACxD,MAAM,IAAA,kDAAyB,EAAC,gBAAgB,CAAC,CAAC;QACpD,CAAC,CAAC,CAAC;QAEH,IAAA,wBAAE,EAAC,uCAAuC,EAAE,KAAK,IAAI,EAAE;YACrD,MAAM,EAAC,MAAM,EAAC,GAAG,IAAA,8BAAkB,GAAE,CAAC;YACtC,MAAM,MAAM,CAAC,QAAQ,CAAC,KAAK,IAAI,EAAE;gBAC/B,MAAM,KAAK,GAAa,EAAE,CAAC;gBAC3B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,EAAE,EAAE;oBAC9B,KAAK,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC;iBACpB;gBACD,aAAa;gBACb,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,cAAc,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC,CAAC;gBACnE,aAAa;gBACb,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,iBAAiB,CAAC,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;gBAC5F,aAAa;gBACb,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,WAAW,CAAC,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,EAAC,GAAG,EAAE,CAAC,EAAE,KAAK,EAAE,KAAK,EAAC,EAAE,EAAE,CAAC,CAAC,CAAC;YACxG,CAAC,CAAC,CAAC;YAEH,MAAM,IAAA,0CAAiB,EAAC,KAAK,CAAC,EAAE,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;YAChD,MAAM,IAAA,iBAAK,EAAC,+BAA+B,EAAE,EAAC,YAAY,EAAE,EAAC,KAAK,EAAE,GAAG,EAAC,EAAC,CAAC,CAAC;YAC3E,MAAM,IAAA,0CAAiB,EAAC,KAAK,CAAC,EAAE,CAAC,KAAK,KAAK,CAAC,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;QAEH,IAAA,wBAAE,EAAC,2DAA2D,EAAE,KAAK,IAAI,EAAE;YACzE,MAAM,EAAC,MAAM,EAAC,GAAG,IAAA,8BAAkB,GAAE,CAAC;YAEtC,MAAM,MAAM,CAAC,QAAQ,CAAC,KAAK,IAAI,EAAE;gBAC/B,MAAM,KAAK,GAAa,EAAE,CAAC;gBAC3B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,EAAE,EAAE;oBAC9B,KAAK,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC;iBACpB;gBACD,aAAa;gBACb,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,cAAc,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC,CAAC;gBACnE,aAAa;gBACb,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,iBAAiB,CAAC,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;gBAC5F,aAAa;gBACb,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,WAAW,CAAC,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,EAAC,GAAG,EAAE,CAAC,EAAE,KAAK,EAAE,KAAK,EAAC,EAAE,EAAE,CAAC,CAAC,CAAC;YACxG,CAAC,CAAC,CAAC;YAEH,MAAM,IAAA,0CAAiB,EAAC,KAAK,CAAC,EAAE,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;YAEhD,MAAM,IAAI,GAAG,MAAM,IAAA,8CAAqB,GAAE,CAAC;YAC3C,mDAAmD;YACnD,aAAM,CAAC,WAAW,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;YACnC,aAAM,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC;YAC5C,aAAM,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC;QAC1C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {assert} from 'chai';\n\nimport {click, getBrowserAndPages, getTestServerPort, waitForFunction} from '../../shared/helper.js';\nimport {describe, it} from '../../shared/mocha-extensions.js';\nimport {doubleClickSourceTreeItem, getPieChartLegendRows, getStorageItemsData, navigateToApplicationTab, waitForQuotaUsage} from '../helpers/application-helpers.js';\n\n// The parent suffix makes sure we wait for the Cookies item to have children before trying to click it.\nconst COOKIES_SELECTOR = '[aria-label=\"Cookies\"].parent';\nconst STORAGE_SELECTOR = '[aria-label=\"Storage\"]';\nconst CLEAR_SITE_DATA_BUTTON_SELECTOR = '#storage-view-clear-button';\nconst INCLUDE_3RD_PARTY_COOKIES_SELECTOR = '[aria-label=\"including third-party cookies\"]';\n\nlet DOMAIN_SELECTOR: string;\n\ndescribe('The Application Tab', async () => {\n  before(async () => {\n    DOMAIN_SELECTOR = `${COOKIES_SELECTOR} + ol > [aria-label=\"https://localhost:${getTestServerPort()}\"]`;\n  });\n\n  afterEach(async () => {\n    const {target} = getBrowserAndPages();\n    const cookies = await target.cookies();\n    await target.deleteCookie(...cookies);\n  });\n\n  it('deletes only first party cookies when clearing site data', async () => {\n    const {target} = getBrowserAndPages();\n    await navigateToApplicationTab(target, 'cross-origin-cookies');\n\n    await doubleClickSourceTreeItem(COOKIES_SELECTOR);\n    await doubleClickSourceTreeItem(DOMAIN_SELECTOR);\n\n    const dataGridRowValuesBefore = await waitForFunction(async () => {\n      const data = await getStorageItemsData(['name', 'value']);\n      return data.length ? data : undefined;\n    });\n\n    assert.sameDeepMembers(dataGridRowValuesBefore, [\n      {\n        name: 'third_party',\n        value: 'test',\n      },\n      {\n        name: 'foo2',\n        value: 'bar',\n      },\n      {\n        name: 'foo',\n        value: 'bar',\n      },\n    ]);\n\n    await doubleClickSourceTreeItem(STORAGE_SELECTOR);\n    await click(CLEAR_SITE_DATA_BUTTON_SELECTOR);\n\n    await doubleClickSourceTreeItem(COOKIES_SELECTOR);\n    await doubleClickSourceTreeItem(DOMAIN_SELECTOR);\n\n    const dataGridRowValuesAfter = await waitForFunction(async () => {\n      const data = await getStorageItemsData(['name', 'value']);\n      return data.length ? data : undefined;\n    });\n    assert.sameDeepMembers(dataGridRowValuesAfter, [{\n                             name: 'third_party',\n                             value: 'test',\n                           }]);\n  });\n\n  it('deletes first and third party cookies when clearing site data with the flag enabled', async () => {\n    const {target} = getBrowserAndPages();\n    // This sets a new cookie foo=bar\n    await navigateToApplicationTab(target, 'cross-origin-cookies');\n\n    await doubleClickSourceTreeItem(COOKIES_SELECTOR);\n    await doubleClickSourceTreeItem(DOMAIN_SELECTOR);\n\n    const dataGridRowValuesBefore = await waitForFunction(async () => {\n      const data = await getStorageItemsData(['name', 'value']);\n      return data.length ? data : undefined;\n    });\n\n    assert.sameDeepMembers(dataGridRowValuesBefore, [\n      {\n        name: 'third_party',\n        value: 'test',\n      },\n      {\n        name: 'foo2',\n        value: 'bar',\n      },\n      {\n        name: 'foo',\n        value: 'bar',\n      },\n    ]);\n\n    await doubleClickSourceTreeItem(STORAGE_SELECTOR);\n    await click(INCLUDE_3RD_PARTY_COOKIES_SELECTOR);\n    await click(CLEAR_SITE_DATA_BUTTON_SELECTOR);\n\n    await doubleClickSourceTreeItem(COOKIES_SELECTOR);\n    await doubleClickSourceTreeItem(DOMAIN_SELECTOR);\n\n    await waitForFunction(async () => {\n      const data = await getStorageItemsData(['name', 'value']);\n      return data.length === 0;\n    });\n  });\n\n  describe('the Storage pane', async function() {\n    // The tests in this suite are particularly slow, as they perform a lot of actions\n    this.timeout(20000);\n    beforeEach(async () => {\n      const {target} = getBrowserAndPages();\n      await navigateToApplicationTab(target, 'storage-quota');\n      await doubleClickSourceTreeItem(STORAGE_SELECTOR);\n    });\n\n    it('clear button clears storage correctly', async () => {\n      const {target} = getBrowserAndPages();\n      await target.evaluate(async () => {\n        const array: number[] = [];\n        for (let i = 0; i < 20000; i++) {\n          array.push(i % 10);\n        }\n        // @ts-ignore\n        await new Promise(resolve => createDatabase(resolve, 'Database1'));\n        // @ts-ignore\n        await new Promise(resolve => createObjectStore(resolve, 'Database1', 'Store1', 'id', true));\n        // @ts-ignore\n        await new Promise(resolve => addIDBValue(resolve, 'Database1', 'Store1', {key: 1, value: array}, ''));\n      });\n\n      await waitForQuotaUsage(quota => quota > 20000);\n      await click(CLEAR_SITE_DATA_BUTTON_SELECTOR, {clickOptions: {delay: 250}});\n      await waitForQuotaUsage(quota => quota === 0);\n    });\n\n    it('reports storage correctly, including the pie chart legend', async () => {\n      const {target} = getBrowserAndPages();\n\n      await target.evaluate(async () => {\n        const array: number[] = [];\n        for (let i = 0; i < 20000; i++) {\n          array.push(i % 10);\n        }\n        // @ts-ignore\n        await new Promise(resolve => createDatabase(resolve, 'Database1'));\n        // @ts-ignore\n        await new Promise(resolve => createObjectStore(resolve, 'Database1', 'Store1', 'id', true));\n        // @ts-ignore\n        await new Promise(resolve => addIDBValue(resolve, 'Database1', 'Store1', {key: 1, value: array}, ''));\n      });\n\n      await waitForQuotaUsage(quota => quota > 20000);\n\n      const rows = await getPieChartLegendRows();\n      // Only assert that the legend entries are correct.\n      assert.strictEqual(rows.length, 2);\n      assert.strictEqual(rows[0][2], 'IndexedDB');\n      assert.strictEqual(rows[1][2], 'Total');\n    });\n  });\n});\n"]}