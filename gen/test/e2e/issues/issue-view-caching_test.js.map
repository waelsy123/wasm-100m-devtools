{"version":3,"file":"issue-view-caching_test.js","sourceRoot":"","sources":["../../../../../../test/e2e/issues/issue-view-caching_test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {assert} from 'chai';\n\nimport {assertNotNullOrUndefined, getBrowserAndPages, goToResource, setCheckBox, waitFor, waitForFunction} from '../../shared/helper.js';\nimport {describe, it} from '../../shared/mocha-extensions.js';\nimport {getResourcesElement} from '../helpers/issues-helpers.js';\nimport {ensureResourceSectionIsExpanded, expandIssue, getIssueByTitle, navigateToIssuesTab, waitForTableFromResourceSectionContents} from '../helpers/issues-helpers.js';\n\ndescribe('IssueView cache', async () => {\n  it('should correctly update the issue', async () => {\n    await goToResource('empty.html');\n    const {target} = getBrowserAndPages();\n    async function triggerIssue() {\n      await target.evaluate(async () => {\n        const url = new URL('./issues/acac-invalid.rawresponse', document.location.toString())\n                        .toString()\n                        .replace('localhost', 'devtools.oopif.test');\n        try {\n          await fetch(url, {\n            method: 'POST',\n            credentials: 'include',\n            headers: {'Content-Type': 'application/json'},\n            body: JSON.stringify({geeting: 'hello'}),\n          });\n        } catch (e) {\n        }\n        try {\n          await fetch(url, {credentials: 'include'});\n        } catch (e) {\n        }\n      });\n    }\n    await triggerIssue();\n    await navigateToIssuesTab();\n    async function waitForResources(numberOfAggregatedIssues: number, expectedTableRows: string[][]) {\n      await expandIssue();\n      const issueElement = await getIssueByTitle('Ensure CORS requests include credentials only when allowed');\n      assertNotNullOrUndefined(issueElement);\n      const section = await getResourcesElement('requests', issueElement, '.cors-issue-affected-resource-label');\n      await waitForFunction(async () => {\n        const text = await section.label.evaluate(el => el.textContent);\n        const expected = numberOfAggregatedIssues === 1 ? '1 request' : `${numberOfAggregatedIssues} requests`;\n        return text === expected;\n      });\n      await ensureResourceSectionIsExpanded(section);\n      await waitForTableFromResourceSectionContents(section.content, expectedTableRows);\n      const adorner = await waitFor('devtools-adorner');\n      const count = await adorner.evaluate(el => el.textContent);\n      assert.strictEqual(count, `${numberOfAggregatedIssues}`);\n    }\n    const header = [\n      'Request',\n      'Status',\n      'Preflight Request (if problematic)',\n      'Access-Control-Allow-Credentials Header Value',\n    ];\n    const expectedRow1 = [\n      'acac-invalid.rawresponse',\n      'blocked',\n      'acac-invalid.rawresponse',\n      'false',\n    ];\n    const expectedRow2 = [\n      'acac-invalid.rawresponse',\n      'blocked',\n      '',\n      'false',\n    ];\n    await waitForResources(2, [header, expectedRow1, expectedRow2]);\n    await setCheckBox('[aria-label=\"Include third-party cookie issues\"]', true);\n\n    // Trigger issue again to see if resources are updated.\n    await triggerIssue();\n    await waitForResources(4, [header, expectedRow1, expectedRow2, expectedRow1, expectedRow2]);\n  });\n});\n"]}